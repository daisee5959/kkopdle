<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê¼½ë“¤ - ë‹¨ì–´ ë§ì¶”ê¸°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyA8-l4m5w-4fWn7W8POlsiYLvYDBMwlf-4",
      authDomain: "kkopdle.firebaseapp.com",
      projectId: "kkopdle",
      storageBucket: "kkopdle.firebasestorage.app",
      messagingSenderId: "309883321240",
      appId: "1:309883321240:web:ad3281d758f70dbc3dc9ed"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
    window.firebaseDB = db;
    window.firebaseAddDoc = addDoc;
    window.firebaseGetDocs = getDocs;
    window.firebaseCollection = collection;
    window.firebaseQuery = query;
    window.firebaseOrderBy = orderBy;
  </script>
  
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: 'Gowun Dodum', sans-serif;
    }
  </style>
</head>
<body>
  <div class="min-h-screen bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 flex items-center justify-center p-4">
    <div class="max-w-md w-full">
      
      <!-- ì œëª© -->
      <div class="text-center mb-8">
        <h1 class="text-6xl font-black text-purple-600 mb-2">ê¼½ë“¤</h1>
        <p class="text-gray-600 font-medium">5ê¸€ì ë‹¨ì–´ ë§ì¶°ë³´ì„¸ìš”!</p>
      </div>

      <!-- ê²Œì„íŒ -->
      <div id="game-board" class="bg-white/80 backdrop-blur-sm rounded-3xl p-6 shadow-2xl mb-6">
        <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„± -->
      </div>

      <!-- ì…ë ¥ì°½ (ë³´ì´ê²Œ!) -->
      <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-4 shadow-lg mb-4">
        <div class="flex justify-between items-center mb-2">
          <p class="text-sm text-gray-600 font-medium">ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš” â¬‡ï¸</p>
          <button onclick="changeNickname()" id="nicknameButton" class="text-xs text-purple-500 font-bold">ë‹‰ë„¤ì„: ë¡œë”©ì¤‘...</button>
        </div>
        <input 
          type="text" 
          id="wordInput"
          placeholder="5ê¸€ì ì…ë ¥"
          maxlength="5"
          class="w-full text-3xl font-black text-center p-4 rounded-xl border-4 border-purple-300 focus:border-purple-500 focus:outline-none bg-white"
          autocomplete="off"
        >
      </div>

      <!-- ë²„íŠ¼ -->
      <div class="flex gap-3 mb-6">
        <button 
          onclick="clearInput()"
          class="flex-1 bg-red-400 hover:bg-red-500 active:bg-red-600 text-white font-bold py-4 rounded-2xl shadow-lg transition-all text-lg">
          ì§€ìš°ê¸°
        </button>
        <button 
          onclick="showRanking()"
          class="flex-1 bg-gray-800 hover:bg-gray-900 active:bg-black text-white font-bold py-4 rounded-2xl shadow-lg transition-all text-lg">
          ë­í‚¹
        </button>
        <button 
          onclick="submitGuess()"
          class="flex-1 bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-all text-lg">
          í™•ì¸ âœ“
        </button>
      </div>

      <!-- ì„¤ëª… -->
      <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-4 shadow-lg text-sm">
        <div class="flex items-center gap-2 mb-2">
          <div class="w-8 h-8 bg-green-500 rounded"></div>
          <span class="text-gray-700 font-medium">ì •í™•í•œ ìœ„ì¹˜</span>
        </div>
        <div class="flex items-center gap-2 mb-2">
          <div class="w-8 h-8 bg-yellow-400 rounded"></div>
          <span class="text-gray-700 font-medium">ìˆì§€ë§Œ ìœ„ì¹˜ í‹€ë¦¼</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-gray-400 rounded"></div>
          <span class="text-gray-700 font-medium">ì—†ëŠ” ê¸€ì</span>
        </div>
      </div>

      <!-- ë­í‚¹ ëª¨ë‹¬ -->
      <div id="rankingModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl p-8 text-center max-w-md w-full shadow-2xl max-h-[80vh] overflow-y-auto">
          <h2 class="text-4xl font-black text-purple-600 mb-6">ë­í‚¹</h2>
          <div id="rankingList" class="text-left mb-6">
            <div class="text-center text-gray-500">ë¡œë”© ì¤‘...</div>
          </div>
          <button 
            onclick="closeRanking()" 
            class="w-full bg-purple-500 hover:bg-purple-600 active:bg-purple-700 text-white font-bold py-4 px-10 rounded-full shadow-lg text-xl">
            ë‹«ê¸°
          </button>
        </div>
      </div>

      <!-- ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ -->
      <div id="nicknameModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl p-8 text-center max-w-sm w-full shadow-2xl">
          <h2 class="text-3xl font-black text-purple-600 mb-4">ë‹‰ë„¤ì„ ì…ë ¥</h2>
          <p class="text-gray-600 mb-6">ë­í‚¹ì— í‘œì‹œë  ì´ë¦„ì´ì—ìš”</p>
          <input 
            type="text" 
            id="nicknameInput"
            placeholder="ë‹‰ë„¤ì„"
            class="w-full text-xl font-bold text-center p-4 rounded-xl border-4 border-purple-300 focus:border-purple-500 focus:outline-none bg-white mb-6"
            autocomplete="off"
          >
          <button 
            onclick="saveNickname()" 
            class="w-full bg-purple-500 hover:bg-purple-600 active:bg-purple-700 text-white font-bold py-4 px-10 rounded-full shadow-lg text-xl">
            ì‹œì‘í•˜ê¸°
          </button>
        </div>
      </div>

      <!-- ê²°ê³¼ ëª¨ë‹¬ -->
      <div id="resultModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl p-10 text-center max-w-sm w-full shadow-2xl">
          <div id="resultEmoji" class="text-7xl mb-6"></div>
          <h2 id="resultTitle" class="text-4xl font-black mb-4"></h2>
          <p id="resultMessage" class="text-xl text-gray-600 mb-2 font-bold"></p>
          <button 
            onclick="location.reload()" 
            class="mt-6 bg-purple-500 hover:bg-purple-600 active:bg-purple-700 text-white font-bold py-4 px-10 rounded-full shadow-lg text-xl">
            ë‹¤ì‹œ í•˜ê¸°
          </button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ë‹¨ì–´ ëª©ë¡
    const words = [
      'ìŠ¤íƒ€ë“€ë°¸ë¦¬',
      'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
      'ììœ ì´ìš©ê¶Œ',
      'ê³µì°¨ì•Œë°”ìƒ',
      'ì¹¡ì´‰í™•ëŒ€ë²”',
      'ë‚˜ë„ì¢‹ì•„í•´',
      'ì¼ì§„ì´ë¬´ê¸°',
      'ê²Œì„ìŠ¤íƒ€íŠ¸',
      'ìº˜ë¦°ë”ë°•ì œ',
      'ì»¤í”Œë§ˆìš°ìŠ¤',
      'ìŠ¤ìœ„íŠ¸ë°•ìŠ¤',
      'ì‡í…ŒìŒìŠ¤íˆ¬',
      'êµìˆ˜ê°œìƒˆë¼'
    ];

    // ê²Œì„ ìƒíƒœ
    let answer = words[Math.floor(Math.random() * words.length)];
    let currentRow = 0;
    let guesses = [];
    let gameOver = false;
    let playerName = localStorage.getItem('kkopdlePlayerName') || '';

    console.log('ì •ë‹µ:', answer);

    // ë‹‰ë„¤ì„ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateNicknameDisplay() {
      const button = document.getElementById('nicknameButton');
      if (button) {
        button.textContent = 'ë‹‰ë„¤ì„: ' + playerName;
      }
    }

    // ë‹‰ë„¤ì„ í™•ì¸
    if (!playerName) {
      document.getElementById('nicknameModal').classList.remove('hidden');
      document.getElementById('nicknameInput').focus();
    } else {
      updateNicknameDisplay();
    }

    // ë‹‰ë„¤ì„ ì €ì¥
    function saveNickname() {
      const input = document.getElementById('nicknameInput');
      const name = input.value.trim();
      
      if (!name) {
        alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }
      
      playerName = name;
      localStorage.setItem('kkopdlePlayerName', playerName);
      document.getElementById('nicknameModal').classList.add('hidden');
      updateNicknameDisplay();
      drawBoard();
      document.getElementById('wordInput').focus();
    }

    // ì ìˆ˜ ì €ì¥ (Firebase)
    async function saveScore(attempts, won) {
      if (!won) return;
      
      console.log('ì ìˆ˜ ì €ì¥ ì‹œì‘...', {
        nickname: playerName,
        word: answer,
        attempts: attempts
      });
      
      try {
        await window.firebaseAddDoc(window.firebaseCollection(window.firebaseDB, 'scores'), {
          nickname: playerName,
          word: answer,
          attempts: attempts,
          timestamp: new Date()
        });
        
        console.log('âœ… ì ìˆ˜ ì €ì¥ ì™„ë£Œ!');
      } catch (error) {
        console.error('âŒ ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', error);
      }
    }

    // ë‹‰ë„¤ì„ ë³€ê²½
    function changeNickname() {
      document.getElementById('nicknameInput').value = playerName;
      document.getElementById('nicknameModal').classList.remove('hidden');
      document.getElementById('nicknameInput').focus();
    }

    // ë­í‚¹ ë³´ê¸° (Firebase - í‰ê·  ì‹œë„ íšŸìˆ˜)
    async function showRanking() {
      const modal = document.getElementById('rankingModal');
      const list = document.getElementById('rankingList');
      
      modal.classList.remove('hidden');
      list.innerHTML = '<div class="text-center text-gray-500">ë¡œë”© ì¤‘...</div>';
      
      try {
        const scoresRef = window.firebaseCollection(window.firebaseDB, 'scores');
        const snapshot = await window.firebaseGetDocs(scoresRef);
        
        const data = [];
        snapshot.forEach((doc) => {
          data.push(doc.data());
        });
        
        if (data.length === 0) {
          list.innerHTML = '<div class="text-center text-gray-500">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”!</div>';
          return;
        }
        
        // ë‹‰ë„¤ì„ë³„ë¡œ ê·¸ë£¹í™”í•˜ê³  í‰ê·  ê³„ì‚°
        const playerStats = {};
        data.forEach(record => {
          if (!playerStats[record.nickname]) {
            playerStats[record.nickname] = {
              nickname: record.nickname,
              totalAttempts: 0,
              count: 0
            };
          }
          playerStats[record.nickname].totalAttempts += record.attempts;
          playerStats[record.nickname].count += 1;
        });
        
        // í‰ê·  ê³„ì‚°
        const rankings = Object.values(playerStats).map(player => ({
          nickname: player.nickname,
          average: (player.totalAttempts / player.count).toFixed(2),
          count: player.count
        }));
        
        // í‰ê·  ì‹œë„ íšŸìˆ˜ ê¸°ì¤€ ì •ë ¬ (ë‚®ì€ ìˆœ)
        const sorted = rankings.sort((a, b) => parseFloat(a.average) - parseFloat(b.average));
        
        // TOP 20
        const top20 = sorted.slice(0, 20);
        
        let html = '';
        top20.forEach((record, index) => {
          const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}ìœ„`;
          const bgColor = index < 3 ? 'bg-yellow-50' : 'bg-gray-50';
          
          html += `
            <div class="${bgColor} rounded-xl p-4 mb-3 border-2 ${index < 3 ? 'border-yellow-400' : 'border-gray-200'}">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <div class="text-2xl font-black">${medal}</div>
                  <div>
                    <div class="font-bold text-gray-800">${record.nickname}</div>
                    <div class="text-xs text-gray-500">${record.count}íšŒ í”Œë ˆì´</div>
                  </div>
                </div>
                <div class="text-2xl font-black text-purple-600">${record.average}íšŒ</div>
              </div>
            </div>
          `;
        });
        
        list.innerHTML = html;
      } catch (error) {
        console.error('ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        list.innerHTML = '<div class="text-center text-red-500">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”</div>';
      }
    }

    // ë­í‚¹ ë‹«ê¸°
    function closeRanking() {
      document.getElementById('rankingModal').classList.add('hidden');
    }

    // ê²Œì„íŒ ê·¸ë¦¬ê¸°
    function drawBoard() {
      const board = document.getElementById('game-board');
      board.innerHTML = '';

      for (let i = 0; i < 6; i++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'flex gap-2 mb-3';

        for (let j = 0; j < 5; j++) {
          const cell = document.createElement('div');
          cell.className = 'flex-1 h-16 rounded-xl flex items-center justify-center text-3xl font-black shadow-lg transition-all';
          
          if (i < guesses.length) {
            // ì œì¶œëœ í–‰
            const char = guesses[i][j];
            const color = getColor(guesses[i], j);
            cell.className += ` ${color} text-white`;
            cell.textContent = char;
          } else {
            // ë¹ˆ í–‰
            cell.className += ' bg-gray-200 border-2 border-gray-300';
          }

          rowDiv.appendChild(cell);
        }

        board.appendChild(rowDiv);
      }
    }

    // ìƒ‰ìƒ ê²°ì •
    function getColor(guess, index) {
      const char = guess[index];
      
      // ì •í™•í•œ ìœ„ì¹˜
      if (char === answer[index]) {
        return 'bg-green-500';
      }
      
      // ìˆì§€ë§Œ ìœ„ì¹˜ í‹€ë¦¼
      if (answer.includes(char)) {
        return 'bg-yellow-400';
      }
      
      // ì—†ëŠ” ê¸€ì
      return 'bg-gray-400';
    }

    // ì…ë ¥ ì§€ìš°ê¸°
    function clearInput() {
      document.getElementById('wordInput').value = '';
      document.getElementById('wordInput').focus();
    }

    // ì œì¶œ
    function submitGuess() {
      if (gameOver) return;

      const input = document.getElementById('wordInput');
      const guess = input.value.trim();

      if (guess.length !== 5) {
        alert('5ê¸€ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
      }

      // í•œê¸€ë§Œ í™•ì¸
      if (!/^[ê°€-í£]{5}$/.test(guess)) {
        alert('í•œê¸€ 5ê¸€ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤!');
        return;
      }

      guesses.push(guess);
      currentRow++;

      // ì •ë‹µ ì²´í¬
      if (guess === answer) {
        gameOver = true;
        saveScore(currentRow, true); // ì ìˆ˜ ì €ì¥
        showResult(true);
      } else if (currentRow >= 6) {
        gameOver = true;
        showResult(false);
      }

      input.value = '';
      drawBoard();
      input.focus();
    }

    // ê²°ê³¼ í‘œì‹œ
    function showResult(won) {
      const modal = document.getElementById('resultModal');
      const emoji = document.getElementById('resultEmoji');
      const title = document.getElementById('resultTitle');
      const message = document.getElementById('resultMessage');

      if (won) {
        emoji.textContent = 'ğŸ‰';
        title.textContent = 'ì •ë‹µ!';
        title.className = 'text-4xl font-black text-green-600 mb-4';
        message.textContent = `${currentRow}ë²ˆ ë§Œì— ë§ì·„ì–´ìš”!`;
      } else {
        emoji.textContent = '';
        title.textContent = 'ë“œë””ì–´ ë„ˆë„ í‹€ë¦¬ëŠ”êµ¬ë‚˜';
        title.className = 'text-4xl font-black text-red-500 mb-4';
        message.textContent = `ì •ë‹µì€ "${answer}" ì„`;
      }

      modal.classList.remove('hidden');
    }

    // ì—”í„°í‚¤ë¡œ ì œì¶œ
    document.getElementById('wordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitGuess();
      }
    });

    // ë‹‰ë„¤ì„ ì…ë ¥ ì—”í„°í‚¤
    document.getElementById('nicknameInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        saveNickname();
      }
    });

    // ì´ˆê¸° ê·¸ë¦¬ê¸°
    drawBoard();
    document.getElementById('wordInput').focus();
  </script>
</body>
</html>
